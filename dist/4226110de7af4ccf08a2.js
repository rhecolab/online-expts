import{randomizeFull,makeSeq}from"../../funcs/randomization.js";import{saveData}from"../../funcs/saveData.js";import{drawShape,drawCircle,drawTriangle,drawSquare,drawSemicircle,drawPolygon}from"../../funcs/utils.js";import html from"./shapeBlink.html";import"../../funcs/blink.css";const stimON=150,stimOFF=50;let trialStartTime,ctx,trialNum=0,data=[],currentTrial=null,currentTrialRow=0,trialTotal=0,fullSeq=[],subjID="";const taskName="shapeBlink";async function startTask(t){subjID=t;const e=document.createElement("div");e.id="expRoot",document.querySelector(".SkinInner").appendChild(e),e.innerHTML=html;const l=randomizeFull(["circle","square","triangle","pentagon"],["semiup","semidown","semileft","semiright"],[0,3,9],2);fullSeq=makeSeq(l,"shape"),window.trials=l,trialTotal=window.trials.length,document.getElementById("startButton").addEventListener("click",()=>{document.getElementById("instrBox").style.display="none",document.getElementById("startButton").style.display="none",runTrial(fullSeq[trialNum])})}export default{startTask};function runTrial(t){currentTrial=t;let e=0;currentTrialRow=NaN,currentTrial.stimuli=t.stimOrder;const l=t.stimOrder;function n(){if(e<l.length){const t=l[e];console.log(t),changeStim(t),e++,setTimeout(r,150)}else collectResp(1,t)}function r(){ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),setTimeout(n,50)}trialStartTime=performance.now(),n()}function changeStim(t){let e;console.log(t.stim,t.type),e="t1"===t.type?"white":"black",drawShape(t.stim,ctx,ctx.canvas.width/2,ctx.canvas.height/2,e)}function endTask(){console.log("Task complete."),console.log("Data:",data);const t=JSON.stringify(data);Qualtrics.SurveyEngine.setEmbeddedData("blinkData",t),document.querySelector("#NextButton").click()}window.collectResp=function(t,e=null){const l=trials[trialNum];console.log("t1",l.t1),console.log("t2",l.t2),console.log("lag",l.lag);const n=document.getElementById("q1"),r=document.getElementById("q2");1===t&&(currentTrialRow={t1_item:l.t1,t2_item:l.t2,lag:l.lag,resp1:"",resp2:"",t1_pos:"",t2_pos:"",rt1:"",rt2:"",time:now.toISOString().split("T")[0]+" "+now.toTimeString().split(" ")[0],seqLen:currentTrial.stimuli.length,seqOrder:currentTrial.stimuli.map(t=>t.stim).join(",")}),2===t&&null!==e&&(currentTrialRow.resp1=e,currentTrialRow.rt1=performance.now()-trialStartTime,currentTrialRow.rt2=performance.now()-trialStartTime),3===t&&null!==e&&(currentTrialRow.resp2=e),1===t&&(n&&(n.style.display="block"),r&&(r.style.display="none")),2===t&&(n&&(n.style.display="none"),r&&(r.style.display="block")),3===t&&(data.push(currentTrialRow),currentTrialRow=null,n&&(n.style.display="none"),r&&(r.style.display="none"),trialNum++,trialNum<trialTotal?runTrial(fullSeq[trialNum]):endTask(subjID,taskName))};